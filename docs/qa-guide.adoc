NUT Quality Assurance Guide
===========================
:Author: Jim_Klimov
:Author Initials: JK

WARNING: This is a Work In Progress document.

/////////////////////
// Note on use of ":leveloffset: N" with absolute values below
//
// While docs recommend relative offsets or using them as parameters
// to the include macro, this is a feature of asciidoctor - not asciidoc-py
// (older implementation) that we rely on in most operating systems:
// https://docs.asciidoctor.org/asciidoc/latest/directives/include-with-leveloffset/
//
// So we resort to absolute offsets (as explicitly not recommended) in the
// document itself, that `Title.level` handling in the older code base supports:
// https://github.com/asciidoc-py/asciidoc-py/blob/main/asciidoc/asciidoc.py#L1775
/////////////////////

Abstract
--------

The aim of this document is to describe the different ways we ensure and
maintain the source code quality of Network UPS Tools, its portability to
various platforms, and non-regression.

Previous NUT releases may have included parts of this documentation in the
developer guide or user manual. Most of this information can be applied to
both automated testing environments and local development workflows.

[[nut-qa]]
include::nut-qa.txt[]

Code and recipe analysis
------------------------

GNU Autotools distcheck
~~~~~~~~~~~~~~~~~~~~~~~
[[CI_distcheck]]

The Network UPS Tools project code base is managed by the
link:https://www.gnu.org/software/automake/manual/html_node/GNU-Build-System.html[GNU
Build System] colloquially known as "The Autotools", which include `autoconf`,
`automake` and many other components. Some of their important roles are to
generate the portable shell `configure` script to detect build environment
capabilities and other nuances, and to help actually build the project with
`Makefile` recipes (supported by many implementations of the standard POSIX
`make` tool) generated from the `Makefile.am` templates by the `automake` tool.

Among the many standard recipes promulgated by the Autotools, `make dist`
handles creation of archive files with a release (or other) snapshot of a
software project, which "distribute" all the original or generated files
needed to build and install that project on a minimally capable end-user
system (should have a compiler, `make`, and dependency libraries/headers,
but is not required to have autotools, manual page generation tools, etc.)

The `make distcheck` goal allows to validate that the constructed archive
is in fact sufficient for such a build (includes all required files), and
also that the code structure and its recipes properly support out-of-tree
builds (as used on multi-platform and cross-build environments) without
contaminating the source code directory structure.

NUT's root `Makefile.am` defines the `DISTCHECK_FLAGS` eventually passed
to the `configure` script executed as part of `distcheck` validation, and
the default set of the flags requires to build everything.  This in turn
constrains the set of systems where this validation can be performed to
build environments that have all dependency projects installed, have the
documentation generation tools, etc. in order to make sure that for all
files that are compiled or otherwise processed by the build routine, we
actually distribute the sources (implicitly as calculated by programs'
listed sources, or via explicit `EXTRA_DIST` and similar statements)
regardless of features enabled or not to be built in the original run.

To avoid this constraint and allow the relevant `distcheck`-like validation
to happen on environments without "everything and a kitchen sink" installed,
further recipes are defined by NUT, such as:

* `distcheck-light`: does not *require* the optional features to be built,
  but just allow them (using `--with-all=auto --with-ssl=auto --with-doc=auto`
  etc. flags);
* `distcheck-light-man`: similar to the above, but require validation that
  manual pages can all be built (do not build PDF or HTML formats, though);
* `distcheck-fake-man`: for formal validation on systems without documentation
  processing tools used by NUT recipes, populate the distribution archive
  with "PLACEHOLDER" contents of missing pre-generated manual pages (such an
  archive SHOULD NOT be delivered to end-users as a fully functional release),
  so the validation of *recipes* around pre-built documentation installation
  can be performed;
* `distcheck-ci`: based on current build circumstances, dispatch to standard
  strict `distcheck` or to `distcheck-fake-man`.

Other recipes based on this concept are also defined, including:

* `distcheck-valgrind`: build whatever code we can, and do not waste time on
  documentation processing (`--with-all=auto --with-ssl=auto --with-doc=skip`),
  to run the NUT test programs (`make check` in the built environment) through
  the <<CI_VALGRIND,Valgrind>> memory-checking tool.

Valgrind checks
~~~~~~~~~~~~~~~
[[CI_VALGRIND]]

FIXME: Write the chapter text.

Static analysis by compilers
~~~~~~~~~~~~~~~~~~~~~~~~~~~~

FIXME: Write the chapter text.

Shell script checks
~~~~~~~~~~~~~~~~~~~
[[CI_shellcheck]]

FIXME: Write the chapter text.

Documentation spelling checks
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
[[CI_spellcheck]]

FIXME: Write the chapter text.


Test automation
---------------

The ci_build.sh script
~~~~~~~~~~~~~~~~~~~~~~
[[CI_BUILD_SH]]

FIXME: Write the chapter text.

Test programs in NUT codebase
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

FIXME: Write the chapter text.

NUT Integration Testing suite (NIT)
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
[[NIT]]

FIXME: Write the chapter text.

Continuous Integration (NUT CI farm)
------------------------------------
[[NUTCI_farm]]

CI Farm configuration notes
~~~~~~~~~~~~~~~~~~~~~~~~~~~
[[CI_Farm_Notes]]

NOTE: This chapter contains information about NUT CI farm setup tricks
that were applied at different times by the maintainer team to ensure
regular builds and tests of the codebase.  Whether these are used in
daily production today or not, similar setup should be possible locally
on developer and contributor machines.

Multiple FOSS CI providers and technologies
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

While there are many FOSS-friendly CI offerings, they are usually (and
reasonably) focused on the OS market leaders -- offering recent releases
of Linux, Windows and MacOS build agents, and sometimes a way to "bring
your own device" to cover other systems.  The NUT CI farm does benefit
from those offerings as well, using GitHub Actions with CodeQL for Linux
code quality inspection, AppVeyor CI for Windows, and CircleCI for MacOS,
to name a few.

But on the other hand, being a massively multi-platform effort (and aiming
to support older boxes that are still alive even if their vendors and/or
distro versions are not), a comprehensive NUT CI approach requires many
machines running uncommon operating systems.  This is where custom virtual
machines help, and more so -- a core set of those hosted in the cloud and
dedicated to the project, rather than only some resources intermittently
contributed by community members which come and go.

NOTE: Community-provided builders running on further systems are also
welcome, and the option is of course supported, as managed by the
link:https://github.com/networkupstools/jenkins-dynamatrix[Jenkins-Dynamatrix]
effort which appeared due to such need, and runs the core NUT CI farm.

We have also had historic experience with FOSS CI providers (and community
members' machines) disappearing, so having NUT CI farm goals covered by
multiple independent implementations is also a feature beyond having yet
another set of digital eyes looking at our code quality (which is also a
goal in itself).

Jenkins is the way
~~~~~~~~~~~~~~~~~~

* https://stories.jenkins.io/user-story/jenkins-is-the-way-for-networkupstools/
* https://github.com/jenkins-infra/stories/blob/main/src/user-story/jenkins-is-the-way-for-networkupstools/index.yaml

The jenkins-dynamatrix library
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
[[Jenkins_Dynamatrix_Library]]

FIXME: Write the chapter text.

Jenkinsfile-dynamatrix cases in NUT sources
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
[[Jenkins_Dynamatrix_Pipeline]]

FIXME: Write the chapter text.

Custom NUT CI farm build agents: VMs on DigitalOcean
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
[[CI_VM_DigitalOcean]]

This section details Installation of VMs on Digital Ocean.

:leveloffset: 1

include::ci-farm-do-setup.adoc[]

:leveloffset: 0

Custom NUT CI farm build agents: LXC containers
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
[[CI_LXC]]

This section details configuration of LXC containers as build environments
for NUT CI farm; this approach can also be used on developer workstations.

:leveloffset: 1

include::ci-farm-lxc-setup.txt[]

:leveloffset: 0

Prerequisites for building NUT on different OSes
------------------------------------------------
[[NUT_Config_Prereqs]]

:leveloffset: 1

include::config-prereqs.txt[]

:leveloffset: 0
